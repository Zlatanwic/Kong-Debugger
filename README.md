# deet ğŸ”

ä¸€ä¸ªç”¨ Rust ç¼–å†™çš„è½»é‡çº§ Linux è°ƒè¯•å™¨ï¼Œæ”¯æŒæ–­ç‚¹ã€å•æ­¥æ‰§è¡Œã€å›æº¯å’Œå˜é‡æŸ¥çœ‹ï¼Œç±»ä¼¼ GDB çš„æ ¸å¿ƒåŠŸèƒ½ã€‚

> æœ¬é¡¹ç›®æ˜¯ Stanford CS110L è¯¾ç¨‹ Project 1 çš„å®ç°ã€‚

## åŠŸèƒ½ç‰¹æ€§

| åŠŸèƒ½ | å‘½ä»¤ | è¯´æ˜ |
|------|------|------|
| è¿è¡Œç¨‹åº | `r` / `run` | å¯åŠ¨æˆ–é‡å¯è¢«è°ƒè¯•ç¨‹åº |
| è®¾ç½®æ–­ç‚¹ | `b` / `break` | æ”¯æŒå‡½æ•°åã€è¡Œå·ã€åŸå§‹åœ°å€ |
| ç»§ç»­æ‰§è¡Œ | `c` / `cont` / `continue` | ä»æ–­ç‚¹ç»§ç»­è¿è¡Œ |
| å•æ­¥æ‰§è¡Œ | `n` / `next` | æ‰§è¡Œåˆ°ä¸‹ä¸€è¡Œæºä»£ç  |
| æŸ¥çœ‹å˜é‡ | `p` / `print` | æ‰“å°å½“å‰ä½œç”¨åŸŸä¸­çš„å˜é‡å€¼ |
| è°ƒç”¨æ ˆå›æº¯ | `bt` / `backtrace` | æ˜¾ç¤ºå®Œæ•´çš„å‡½æ•°è°ƒç”¨æ ˆ |
| é€€å‡º | `q` / `quit` | ç»ˆæ­¢è°ƒè¯•ä¼šè¯ |

## å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

- **Linux** (éœ€è¦ ptrace ç³»ç»Ÿè°ƒç”¨)
- **Rust** å·¥å…·é“¾ (edition 2018+)
- **GCC** (ç”¨äºç¼–è¯‘ç¤ºä¾‹ C ç¨‹åº)

### ç¼–è¯‘

```bash
# ç¼–è¯‘è°ƒè¯•å™¨
cargo build

# ç¼–è¯‘ç¤ºä¾‹ç¨‹åºï¼ˆéœ€è¦ -g è°ƒè¯•ç¬¦å·ï¼‰
make
```

### è¿è¡Œ

```bash
cargo run samples/segfault
```

## ä½¿ç”¨ç¤ºä¾‹

```
(kdb) b func2              # åœ¨ func2 å‡½æ•°å…¥å£è®¾æ–­ç‚¹
Set breakpoint 0 at 0x401156

(kdb) r                     # è¿è¡Œç¨‹åº
Calling func2
Child stopped (signal SIGTRAP)
Stopped at func2 /path/to/segfault.c:3
3    void func2(int a) {

(kdb) n                     # å•æ­¥åˆ°ä¸‹ä¸€è¡Œ
Stopped at func2 /path/to/segfault.c:4
4        printf("About to segfault... a=%d\n", a);

(kdb) p a                   # æŸ¥çœ‹å˜é‡ a
a = 2 (int)

(kdb) bt                    # æŸ¥çœ‹è°ƒç”¨æ ˆ
func2: /path/to/segfault.c:4
func1: /path/to/segfault.c:11
main: /path/to/segfault.c:15

(kdb) c                     # ç»§ç»­è¿è¡Œ
```

### æ–­ç‚¹è®¾ç½®æ–¹å¼

```
(kdb) b main                # æŒ‰å‡½æ•°å
(kdb) b 15                  # æŒ‰è¡Œå·
(kdb) b *0x401156           # æŒ‰åŸå§‹åœ°å€
```

## ç¼–è¯‘ç›®æ ‡ç¨‹åºçš„æ³¨æ„äº‹é¡¹

è¢«è°ƒè¯•çš„ç›®æ ‡ç¨‹åºéœ€è¦ä½¿ç”¨ä»¥ä¸‹ç¼–è¯‘é€‰é¡¹ä»¥ç¡®ä¿è°ƒè¯•ä¿¡æ¯å®Œæ•´ï¼š

```bash
gcc -O0 -g -no-pie -fno-omit-frame-pointer -o program program.c
```

- `-O0` â€” ç¦ç”¨ä¼˜åŒ–
- `-g` â€” ç”Ÿæˆ DWARF è°ƒè¯•ä¿¡æ¯
- `-no-pie` â€” ç¦ç”¨åœ°å€éšæœºåŒ–
- `-fno-omit-frame-pointer` â€” ä¿ç•™å¸§æŒ‡é’ˆï¼ˆbacktrace éœ€è¦ï¼‰

## ç¤ºä¾‹ç¨‹åº

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `samples/hello.c` | Hello World |
| `samples/count.c` | ç®€å•æ‰“å° 1-5 |
| `samples/segfault.c` | æ®µé”™è¯¯ç¤ºä¾‹ï¼Œç”¨äºæµ‹è¯•ä¿¡å·å¤„ç† |
| `samples/function_calls.c` | å¤šå±‚å‡½æ•°è°ƒç”¨ï¼Œç”¨äºæµ‹è¯• backtrace |
| `samples/sleepy_print.c` | å¸¦ sleep çš„æ‰“å°ï¼Œç”¨äºæµ‹è¯•é•¿è¿è¡Œè¿›ç¨‹ |
| `samples/exit.c` | å¸¦é€€å‡ºç çš„ç¨‹åº |

## æŠ€æœ¯å®ç°

- **è¿›ç¨‹æ§åˆ¶**: ä½¿ç”¨ `ptrace` ç³»ç»Ÿè°ƒç”¨è¿›è¡Œè¿›ç¨‹è·Ÿè¸ªå’Œæ§åˆ¶
- **æ–­ç‚¹**: é€šè¿‡ `INT 3` (0xcc) æŒ‡ä»¤æ³¨å…¥å®ç°è½¯ä»¶æ–­ç‚¹
- **DWARF è§£æ**: ä½¿ç”¨ `gimli` å’Œ `addr2line` åº“è¯»å–è°ƒè¯•ç¬¦å·
- **å˜é‡è¯»å–**: é€šè¿‡ DWARF ä½ç½®ä¿¡æ¯å®šä½å˜é‡åœ¨æ ˆå¸§ä¸­çš„ä½ç½®ï¼Œä½¿ç”¨ `ptrace::read` è¯»å–å†…å­˜
- **å•æ­¥æ‰§è¡Œ**: ä½¿ç”¨ `ptrace::step` è¿›è¡ŒæŒ‡ä»¤çº§å•æ­¥ï¼Œå¾ªç¯ç›´åˆ°æºä»£ç è¡Œå·å˜åŒ–

## License

æœ¬é¡¹ç›®ä¸ºè¯¾ç¨‹ä½œä¸šå®ç°ã€‚
